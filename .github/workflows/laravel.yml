name: Laravel CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, mysqlnd, gd, zip, bcmath

      - name: Create Environment File
        run: |
          cat > .env << 'EOF'
          APP_NAME="Riau Pos - Honda HSBL"
          APP_ENV=testing
          APP_KEY=base64:testkey123456789012345678901234567890
          APP_DEBUG=false
          APP_URL=http://localhost
          
          # Gunakan quotes untuk :memory:
          DB_CONNECTION=sqlite
          DB_DATABASE=":memory:"
          
          CACHE_DRIVER=array
          SESSION_DRIVER=array
          QUEUE_CONNECTION=sync
          FILESYSTEM_DISK=local
          EOF

      - name: Install Dependencies
        run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Check PHP Syntax
        run: |
          echo "ðŸ“ Checking PHP syntax..."
          
          # Check app directory
          for file in $(find app -name "*.php" -type f); do
            php -l "$file" || { echo "âŒ Error in: $file"; exit 1; }
          done
          
          echo "âœ… App syntax OK!"
          
          # Check database directory
          for file in $(find database -name "*.php" -type f); do
            php -l "$file" || { echo "âŒ Error in: $file"; exit 1; }
          done
          
          echo "âœ… Database syntax OK!"
          
          # Check important files
          php -l routes/web.php && echo "âœ… Routes syntax OK!"
          php -l config/app.php && echo "âœ… Config syntax OK!"

      - name: Run Safe Laravel Commands
        run: |
          echo "ðŸš€ Running Laravel commands..."
          php artisan --version
          php artisan config:clear
          php artisan view:clear
          echo "âœ… Commands completed!"

      - name: Final Message
        run: echo "ðŸŽ‰ CI/CD check passed!"